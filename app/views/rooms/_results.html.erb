<%# app/views/rooms/_results.html.erb %>

<%# Ê∏°„Åï„Çå„Åüranked_results„Åã„Çâ„ÄÅÂÖ®„Å¶„ÅÆÂçòË™û„ÅÆË©ï‰æ°„ÅåÂÆå‰∫Ü„Åó„Åü„Åã„Å©„ÅÜ„Åã„ÇíÂà§ÂÆö„Åô„Çã %>
<% all_words_evaluated = ranked_results.flat_map { |r| r[:result][:words] }.all? { |w| w.score.zero? || (w.ai_score.present? && w.chain_bonus_score.present?) } %>

<% if all_words_evaluated %>
  <%# „ÄêË©ï‰æ°ÂÆå‰∫ÜÂæå„ÅÆË°®Á§∫„Äë %>
  <% winner_data = ranked_results.first %>
  <% if winner_data %>
    <div class="alert alert-success mb-4">
      <h2>üèÜ 1‰Ωç: <%= winner_data[:user] ? winner_data[:user].username : winner_data[:guest_name] %> üèÜ</h2>
    </div>
  <% end %>
<% else %>
  <%# „ÄêË©ï‰æ°‰∏≠„ÅÆË°®Á§∫„Äë %>
  <div class="alert alert-info mb-4">
    AIÂà§ÂÆö‰∏≠...
    <div class="spinner-border spinner-border-sm ms-2" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
<% end %>

<div class="ranking-container">
  <%# ‚ñº‚ñº‚ñº ÂîØ‰∏Ä„ÅÆÂ§âÊõ¥ÁÇπ ‚ñº‚ñº‚ñº %>
  <%# `@ranked_results` („Ç§„É≥„Çπ„Çø„É≥„ÇπÂ§âÊï∞) „Çí `ranked_results` („É≠„Éº„Ç´„É´Â§âÊï∞) „Å´Â§âÊõ¥ %>
  <% ranked_results.each do |ranking_data| %>
  <%# ‚ñ≤‚ñ≤‚ñ≤ ÂîØ‰∏Ä„ÅÆÂ§âÊõ¥ÁÇπ ‚ñ≤‚ñ≤‚ñ≤ %>
    <div class="row justify-content-center mb-4">
      <div class="col-md-8">
        <div class="card <%= 'border-warning shadow-lg' if ranking_data[:rank] == 1 %> <%= 'border-primary' if ranking_data[:is_current_user] %>">

          <div class="card-header d-flex align-items-center justify-content-between
                      <%= 'bg-warning text-dark fw-bold' if ranking_data[:rank] == 1 %>
                      <%= 'bg-primary text-white' if ranking_data[:is_current_user] && ranking_data[:rank] != 1 %>
                      <%= 'bg-secondary text-white' if !ranking_data[:is_current_user] && ranking_data[:rank] != 1 %>">

            <div class="d-flex align-items-center">
              <span class="badge
                          <%= 'bg-dark text-warning' if ranking_data[:rank] == 1 %>
                          <%= 'bg-light text-primary' if ranking_data[:rank] != 1 %>
                          fs-5 me-3">
                <%= ranking_data[:rank] %>‰Ωç
              </span>
              <h4 class="mb-0">
                <%# „Ç≤„Çπ„Éà„Å®„É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº‰∏°Êñπ„ÅÆÂêçÂâçË°®Á§∫„Å´ÂØæÂøú %>
                <%= ranking_data[:user] ? ranking_data[:user].username : ranking_data[:guest_name] %>
                <%= ' („ÅÇ„Å™„Åü)' if ranking_data[:is_current_user] %>
              </h4>
            </div>
            <% if ranking_data[:rank] == 1 %>
              <span class="fs-2">üëë</span>
            <% end %>
          </div>

          <div class="card-body text-center">
            <div class="row">
              <div class="col">
                <h3 class="display-5 fw-bold
                          <%= 'text-warning' if ranking_data[:rank] == 1 %>
                          <%= 'text-primary' if ranking_data[:rank] != 1 %>">
                  <%= ranking_data[:result][:total_score] %>
                </h3>
                <small class="text-muted">Á∑èÂêà„Çπ„Ç≥„Ç¢</small>
              </div>
              <div class="col">
                <h5 class="text-secondary"><%= ranking_data[:result][:total_base_score] %></h5>
                <small class="text-muted">Âü∫Á§éÁÇπ</small>
              </div>
              <div class="col">
                <h5 class="text-info"><%= ranking_data[:result][:total_ai_score] %></h5>
                <small class="text-muted">AI„Éú„Éº„Éä„Çπ</small>
              </div>
              <div class="col">
                <h5 class="text-success"><%= ranking_data[:result][:total_chain_bonus_score] %></h5>
                <small class="text-muted">ÈÄ£Èéñ„Éú„Éº„Éä„Çπ</small>
              </div>
            </div>

            <div class="mt-3">
              <span class="badge bg-light text-dark fs-6">
                ‰ΩøÁî®ÂçòË™ûÊï∞: <%= ranking_data[:result][:word_count] %>ÂÄã
              </span>
            </div>
          </div>

          <div class="card-footer">
            <div class="accordion" id="wordsAccordion<%= ranking_data[:rank] %>">
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed"
                          type="button"
                          data-bs-toggle="collapse"
                          data-bs-target="#collapse<%= ranking_data[:rank] %>"
                          aria-expanded="false">
                    <i class="bi bi-list-ul me-2"></i>
                    ÂçòË™ûÂ±•Ê≠¥„ÇíË¶ã„Çã
                  </button>
                </h2>
                <div id="collapse<%= ranking_data[:rank] %>"
                      class="accordion-collapse collapse"
                      data-bs-parent="#wordsAccordion<%= ranking_data[:rank] %>">
                  <div class="accordion-body" style="max-height: 300px; overflow-y: auto;">
                    <% ranking_data[:result][:words].each do |word| %>
                      <%= turbo_frame_tag "word_evaluation_#{word.id}" do %>
                        <div class="d-flex justify-content-between align-items-center mb-2 pb-2">
                          <div class="flex-grow-1 text-start">
                            <p class="fs-6 mb-0 fw-medium"><%= word.body %></p>
                            
                            <%# ÂçòË™ûË©ï‰æ°„ÅÆÁêÜÁî± %>
                            <% if word.ai_evaluation_comment.present? %>
                              <div class="text-muted small mt-1 p-2 bg-light rounded">
                                <i class="bi bi-robot me-1"></i>
                                <%= word.ai_evaluation_comment %>
                              </div>
                            <% end %>
                            
                            <%# ÈÄ£Èéñ„Éú„Éº„Éä„Çπ„ÅÆÁêÜÁî± %>
                            <% if word.chain_bonus_comment.present? %>
                              <div class="text-muted small mt-1 p-2 bg-success bg-opacity-10 rounded">
                                <i class="bi bi-link-45deg me-1"></i>
                                <%= word.chain_bonus_comment %>
                              </div>
                            <% end %>
                          </div>
                          <div class="text-end ms-3" style="min-width: 140px;">
                            <% if word.score.to_i > 0 %>
                              <span class="badge bg-secondary rounded-pill">Âü∫Á§é: <%= word.score %>ÁÇπ</span>
                              <% if word.ai_score.present? %>
                                <span class="badge bg-info rounded-pill">AI: <%= word.ai_score %>ÁÇπ</span>
                              <% else %>
                                <span class="badge bg-light text-dark rounded-pill">
                                  <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                  </div>
                                </span>
                              <% end %>
                              
                              <% if word.chain_bonus_score.present? %>
                                <span class="badge bg-success rounded-pill mt-1">ÈÄ£Èéñ: <%= word.chain_bonus_score %>ÁÇπ</span>
                              <% end %>
                            <% else %>
                              <span class="badge bg-light text-muted rounded-pill">ÈñãÂßãÂçòË™û</span>
                            <% end %>
                          </div>
                        </div>
                      <% end %>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>